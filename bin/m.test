#!/usr/bin/env sh
set -e
NAME="m.test"
PACKAGE=$(dirname $(dirname $(node -pe "require('fs').realpathSync('$0')")))
MODULES="$PACKAGE/global"
PATTERN="*.js"
WATCH=""
while [[ $# -gt 0 ]]; do
  flag="$1"
  case $flag in
      help|-h|--help)
      cat $PACKAGE/man/$NAME.1 \
        | sed '1,8d; $d' \
        | sed -e 's/SYNOPSIS/  Usage:/g' \
        | sed -e 's/OPTIONS/  Options:/g' \
        | sed -e 's/COMMANDS/  Commands:/g'
        exit 0
      ;;
      version|-v|--version)
        node -pe "require('$PACKAGE/package.json').version"
        exit 0
      ;;
      -p|--parallel)
        MAXPROCS="$2"
        shift
      ;;
      -r|--require)
        MODULES="$MODULES -r $2"
        shift
      ;;
      -f|--filter)
        PATTERN="$2"
        shift
      ;;
      -w|--watch)
        WATCH="$PACKAGE/bin/_watch"
      ;;
      *)
        FILES="$FILES $1"
      ;;
  esac
  shift
done

$WATCH find ${FILES:-test} -type f -iname "$PATTERN" | xargs -n 1 -P ${MAXPROCS:-1} node -r $MODULES
